---
title: "Untitled"
author: "Andrew W. Park"
date: '2022-11-18'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadLibs}
library(magrittr)
library(tidyverse)
library(patchwork)
```

```{r loadData}
load("get_finalAnalysis.Rda")
source(knitr::purl("diseaseKernel.Rmd", quiet=TRUE))
load("get_siteData.Rda") #load this last as another script temporarily uses value 'sites'
```

```{r combine}
# sites have enviro data, disease data and culic score data

# start with sites df (enviro data) and add disease data
hdDens <- raster::extract(r,cbind(sites$lon,sites$lat))
sites %<>% mutate(hdDens=hdDens)

#now ad culic score data
siteScores <- unlist(scores[[2]], recursive = TRUE, use.names = TRUE)
sc <- tibble(
  names(siteScores),
  unname(siteScores)
)

sc %<>% rename(Site=`names(siteScores)`,score=`unname(siteScores)`)
sites %<>% left_join(.,sc)
sites %<>% drop_na(score)

sites %<>% mutate(scorePos=score-min(score))
sites %<>% mutate(scoreSqrt=sqrt(scorePos))
sites %<>% mutate(scoreRank=rank(score,ties.method="first"))

```

```{r ordinated}
# create ordinated matrix for plotting
om <- metacom::OrderMatrix(ret.nozero) 

omBoundaries <- tibble(first1=numeric(0),last1=numeric(0))

om <- t(om)

for (i in 1:dim(om)[1]){
  pres <- which(om[i,]==1)
  first1 <- min(pres)
  last1 <- max(pres)
  omBoundaries %<>% add_case(first1=first1,last1=last1)
}

om2 <- matrix(rep(0,dim(om)[1]*dim(om)[2]),nrow=dim(om)[1])
for (i in 1:dim(om2)[1]){
  for (j in as.numeric(omBoundaries[i,1]):as.numeric(omBoundaries[i,2])){
    om2[i,j] <- 1
  }
}

om2 %<>% as_tibble(.)
om2 %<>% mutate(sp=1:dim(om2)[1])
om2 %<>% pivot_longer(starts_with("V"),names_to="site",values_to="pres")

levelSites <- c(paste("V",1:212,sep=""))
levelSp <- 1:52
om2 %<>% mutate(site=factor(site,levels=levelSites))
om2 %<>% mutate(sp=factor(sp,levels=levelSp))
p.ss <- om2 %>% ggplot(.,aes(x=site,y=sp))+geom_tile(aes(fill=as.factor(pres)))+scale_fill_manual(name="Presence",values=c("gray90","gray20"))+xlab("")+ylab("Species\nrange")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank())+theme(legend.position="none")


```




```{r}
#exploratory plots

p1 <- sites %>% ggplot(.,aes(x=scoreRank,y=elev))+geom_point()+geom_smooth(span=1.0)+xlab("")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+ylab("Elevation\n(m)")
p2 <- sites %>% ggplot(.,aes(x=scoreRank,y=prism.ppt))+geom_point()+geom_smooth(span=1.0)+xlab("")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+ylab("Precipitation\n(mm)")
p3 <- sites %>% ggplot(.,aes(x=scoreRank,y=prism.tmean))+geom_point()+geom_smooth(span=1.0)+xlab("Sites")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+ylab("Mean\ntemp (C)")
p4 <- sites %>% ggplot(.,aes(x=scoreRank,y=prism.trange))+geom_point()+geom_smooth(span=1.0)+xlab("")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+ylab("Temp\nrange (C)")
p5 <- sites %>% ggplot(.,aes(x=scoreRank,y=hdDens))+geom_point()+geom_smooth(span=1.0)+xlab("")+theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+ylab("Kernel density\ndisease reports")

png("test.png",width=400,height=600)
p5/p.ss/p2/p4/p1/p3
dev.off()




```


```{r gam}

sites %>% ggplot(.,aes(x=score))+geom_histogram()
sites %>% ggplot(.,aes(x=scoreSqrt))+geom_histogram()
sites %>% ggplot(.,aes(x=log(score+5)))+geom_histogram()


myGam1 <- mgcv::gam(scoreSqrt~s(lon,lat)+
                      prism.ppt+
                      prism.tmean+
                      prism.trange+
                      elev
                    ,family=gaussian,data=sites)



```


```{r}
library(gbm)
library(cowplot)
my.gbm<- gbm(scoreSqrt~lat+lon+prism.ppt+prism.tmean+prism.tmin+prism.tmax+prism.trange+elev,
            data=sites, distribution="gaussian",n.trees=50000,shrinkage=0.001,interaction.depth=5,bag.fraction=0.70,train.fraction=0.8,n.minobsinnode=5,cv.folds=5,keep.data=TRUE,verbose=TRUE)
summary(my.gbm)


best.iter <- gbm.perf(my.gbm,method="cv")
inv<-pdp::partial(my.gbm,n.trees=best.iter,"prism.trange")

plot1 <- inv %>%
  na.omit() %>%
  ggplot() +
  geom_line(aes(x = prism.trange, y = yhat),color="magenta4",size=1) +
  xlim(min(sites$prism.trange),max(sites$prism.trange))+
  ylab(" ") +
  theme_minimal() +
  theme(axis.title.x = element_blank())+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),axis.text=element_text(size=12))

plot2 <- sites %>%
  dplyr::select(prism.trange) %>%
  na.omit() %>%
  ggplot(aes(prism.trange)) +
  geom_histogram(breaks=seq(min(sites$prism.trange),max(sites$prism.trange), by = 1),fill="thistle2") +
  scale_y_continuous(position = "right")+
  ylab("") +
  theme_minimal() +
  theme(axis.title.x = element_blank(),axis.text=element_text(size=12))

p1 <- add_sub(plot1," ")
p2 <- add_sub(plot2,"Temperature range (C)",size=12)
p.tRange<-ggdraw() +
  draw_plot(p2,x=0.05,scale=0.95) +
  draw_plot(p1,x=-0.04,scale=0.975,y=0.05) 


### REL INFL PLOT
par(mfrow=c(1,1))
gbm_full_summary = summary.gbm(my.gbm)

gbm_summary_idx = which(gbm_full_summary$rel.inf > 1)

gbm_full_short = gbm_full_summary[gbm_summary_idx,]

gbm_full_short$var = as.character(gbm_full_short$var)

png("relInf.png")
colors = ifelse(rev(gbm_full_short$rel.inf) >= 2,'black','snow4')
par(mfrow=c(1,1),
    mar=c(5,18,4,2)+0.1)
bar = barplot(rev(gbm_full_short$rel.inf),
              horiz = TRUE,
              xlim = c(0,40),
              xlab = 'Percent Relative Influence',
              col = colors )


axis(2,
     at = bar,
     labels=rev(c('prism.trange', 'prism.tmin', 'prism.tmean', 'lat', 'lon', 'prism.ppt', 'elev', 'prism.tmax'  )),las = 2)
dev.off()

```

